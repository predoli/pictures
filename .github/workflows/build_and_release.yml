name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Build Backend
      run: |
        mkdir -p dist/backend_arm64
        cd backend
        GOOS=linux GOARCH=arm64 go build -o ../dist/backend_arm64/digital-photo-frame main.go webdav_sync.go config.go

    - name: Install Qt dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qt6-base-dev qt6-declarative-dev qt6-base-private-dev libqt6quick6 libqt6quickcontrols2-6

    # Note: Cross-compiling Qt is complex. For this example, we'll assume we can build
    # or we use a container. Since we are on x86_64 runner, we can't build for ARM64 easily without cross-compiler.
    # We will skip the actual Qt build here and assume it's done or mocked for the image step
    # In a real scenario, we would use a Docker container with cross-toolchain.
    
    - name: Build Frontend (Mock for now - Real cross-compile requires setup)
      run: |
        mkdir -p dist/frontend_arm64
        # Create a dummy binary for testing the pipeline if we can't cross-compile
        touch dist/frontend_arm64/appdigital-photo-frame-qt
        chmod +x dist/frontend_arm64/appdigital-photo-frame-qt

    - name: Create Image
      run: |
        sudo bash packaging/create_image.sh
      env:
        DEBIAN_FRONTEND: noninteractive

    - name: Upload Image
      uses: actions/upload-artifact@v3
      with:
        name: digital-photo-frame-image
        path: raspios-lite-arm64.img

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: raspios-lite-arm64.img
